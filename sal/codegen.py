# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/02_code_generation.ipynb.

# %% auto 0
__all__ = ['render_jinja2', 'SalTemplateLoader', 'SalCodeGenerator', 'SalJinja', 'SalJinjaFrontmatter']

# %% ../nbs/02_code_generation.ipynb 2
from .loaders import xml_to_data
from .core import Data, iter_data
from jinja2 import Environment, BaseLoader, Template
from typing import Optional, Any
import abc
from jinja2 import StrictUndefined
from textwrap import dedent
from frontmatter.util import u
from yaml.parser import ParserError
from frontmatter.default_handlers import YAMLHandler

# %% ../nbs/02_code_generation.ipynb 9
def render_jinja2(template: str, filters: Optional[dict]=None, **kwargs: Any) -> str:
    if not filters:
        filters = {}
    
    env = Environment(loader=BaseLoader(), undefined=StrictUndefined)
    env.filters.update(filters)
    
    jinja_tpl: Template = env.from_string(template)
    return jinja_tpl.render(**kwargs)

# %% ../nbs/02_code_generation.ipynb 14
class SalTemplateLoader(abc.ABC):
    @abc.abstractclassmethod
    def get_template(self, name: str):
        pass
    
class SalCodeGenerator(abc.ABC):
    def __init__(self, template_loader: SalTemplateLoader):
        self.template_loader = template_loader

    def get_template(self, name: str):
        return self.template_loader.get_template(name)
    
    @abc.abstractclassmethod
    def render(self, data: Data):
        pass

# %% ../nbs/02_code_generation.ipynb 17
class SalJinja(SalCodeGenerator):    
    
    def _render(self, data: Data):
        template = self.get_template(data.name)
        return render_jinja2(
            template, 
            filters=dict(render=self.render),
            node=data, 
            children=data.children, 
            **data.attrs
        )
        return template
    
    def process_data(self, data: Data):
        return data
    
    def render(self, data: Data):
        data = self.process_data(data)
        return self._render(data)


# %% ../nbs/02_code_generation.ipynb 32
class SalJinjaFrontmatter(SalJinja):
    
    def __init__(self, template_loader: SalTemplateLoader):
        super().__init__(template_loader)
        self.frontmatter_handler = YAMLFrontMatter()
    
    def get_template(self, name: str, frontmatter=False):
        template = super().get_template(name)
        if not frontmatter:
            return self.frontmatter_handler.get_content(template)
        else:
            return self.frontmatter_handler.get_raw_frontmatter(template)
        
    def get_frontmatter_attributes_for_data(self, template: str, data: Data) -> dict:
        fm_rendered = render_jinja2(template, node=data, **data.attrs)  
        fm_parsed = self.frontmatter_handler.parse(fm_rendered)
        return fm_parsed
    
    def process_data(self, data: Data):
        for d, _ in iter_data(data):
            # load template
            template = self.get_template(d.name, frontmatter=True)
            # handle front matter
            new_attributes = self.get_frontmatter_attributes_for_data(template, d)
            # update attributes
            d.attrs.update(new_attributes)
        return data

